## （第一部分 数据系统基础）

## 第1章 可靠、可拓展与可维护的应用系统11

### 一、认识数据系统12

### 二、可靠性14

#### 1. 硬件故障

#### 2. 软件错误

#### 3. 人为失误

#### 4. 可靠性的重要性

### 三、可拓展性18

#### 1. 描述负载

#### 2. 描述性能

#### 3. 应对负载增加的方法

### 四、可维护性25

#### 1. 可运维性：运行更轻松

#### 2. 简单性：简化复杂度

#### 3. 可演化性：易于改变

### 五、小结28

## 第2章 数据模型与查询语言33

### 一、关系模型与文档模型34

#### 1. NOSQL的诞生

#### 2. 对象-关系不匹配

#### 3. 多对一和多对多的关系

#### 4. 文档数据库是否在重演历史

网络模型

关系模型

文档数据库的比较

#### 5.关系数据库与文档数据库现状

哪种数据模型的应用代码更简单？

文档模型中的模式灵活性

查询的数据局部性

文档数据库与关系数据库的融合

### 二、数据查询语言46

#### 1. Web上的声明式查询 48

#### 2. MapReduce查询 50

### 三、图状数据模型52

#### 1. 属性图

#### 2. Cypher查询语言 55

#### 3. SQL中的图查询 56

#### 4. 三元存储与SPARQL 58

语义网

RDF数据模型

SPARQL查询语言

#### 5. Datalog基础 65

### 四、小结65

## 第3章 数据存储与检索71

### 一、数据库核心：数据结构72

#### 1. 哈希索引

#### 2. SSTables和LSM-Tree

构建和维护SSTables

从SSTables到LSM-Tree

性能优化

#### 3. B-trees

使B-tree可靠

优化B-tree

#### 4. 对比B-tree和LSM-tree

LSM-tree的优点

LSM-tree的缺点

#### 5. 其他索引结构

在索引中存储值

多列索引

全文搜索和模糊索引

在内存中保存所有内容

### 二、事务处理与分析处理89

#### 1. 数据仓库 91

OLTP数据库和数据仓库之间的差异

#### 2. 星型与雪花型分析模式

### 三、列式存储94

#### 1. 列压缩

内存宽带和矢量化处理

#### 2. 列存储中的排序

几种不同的排序

#### 3. 列存储的写操作

#### 4. 聚合：数据立方体与物化视图

### 四、小结101

## 第4章 数据编码与演化109

### 一、数据编码格式110

#### 1. 语言特定的格式

#### 2. JSON、XML与二进制变体

二进制编码

#### 3. Thrift与Protocol Buffers

字段标签和模式演化

数据类型和模式烟花

#### 4. Avro

写模式与读模式

模式演化规则

那么writer模式又是什么？

动态生成的模式

代码生成和动态类型语言

#### 5. 模式的优点

### 二、数据流模式124

#### 1. 基于数据库的数据流

不同的时间写入不同的值

归档存储

#### 2. 基于服务的数据流REST和RPC 127

网络服务

远程过程调用（RPC）的问题

RPC的发展方向

RPC的数据编码和演化

#### 3. 基于消息传递的数据流 131

消息代理

分布式Actor框架

### 三、小结134

## （第二部分 分布式数据系统）

## 第5章 数据复制145

### 一、主节点与从节点146

#### 1. 同步复制与异步复制

#### 2. 配置新的从节点

#### 3. 处理节点失效

从节点失效：追赶式恢复

主节点失效：节点切换

#### 4. 复制日志的实现

基于语句的复制

基于预写日志（WAL）的传输

基于行的逻辑日志复制

基于触发器的复制

### 二、复制滞后问题154

#### 1. 读自己的写

#### 2. 单调读

#### 3. 前缀一致读

#### 4. 复制滞后的解决方案

### 三、多主节点复制160

#### 1. 适用场景

多数据中心

离线客户端操作

协作编辑

#### 2. 处理写冲突

同步与异步冲突检测

避免冲突

收敛于一致状态

自定义冲突解决逻辑

什么是冲突？

#### 3. 拓扑结构

### 四、无主节点复制168

#### 1. 节点失效时写入数据库

读修复与反熵

读写quorum

#### 2. Quorum一致性的局限性

监控旧值

宽松的quorum与数据回传

多数据中心操作

#### 3. 检测并发写

最后写入者获胜（丢弃并发写入）

Happens-before关系和并发

确定前后关系

合并同时写入的值

版本矢量

### 五、小结181

## 第6章 数据分区189

### 一、数据分区与数据复制190

### 二、键-值数据的分区190

#### 1. 基于关键字区间分区

#### 2. 基于关键字哈希值分区

#### 3. 负载倾斜与热点

### 三、分区与二级索引195

#### 1. 基于文档分区的二级索引

#### 2. 基于词条的二级索引分区

### 四、分区再平衡198

#### 1. 动态再平衡的策略

为什么不用取模？

固定数量的分区

动态分区

按节点比例分区

#### 2. 自动与手动再平衡操作

### 五、请求路由202

#### 1. 并行查询执行

### 六、小结204

## 第7章 事务211

### 一、深入理解事务212

#### 1. ACID的含义

原子性

一致性

隔离性

持久性

#### 2. 单对象与多对象事务操作

单对象写入

多对象事务的必要性

处理错误与中止

### 二、弱隔离级别221

#### 1. 读-提交

防止脏读

防止脏写

实现读-提交

#### 2. 快照级别隔离与可重复读

实现快照隔离级别

一致性快照的可见性规则

索引与快照级别隔离

可重复读与命名混淆

#### 3. 防止更新丢失

原子写操作

显式加锁

自动检测更新丢失

原子比较和设置

冲突解决与复制

#### 4. 写倾斜与幻读

定义写倾斜

更多写倾斜的例子

为何产生写倾斜

### 三、串行化237

#### 1. 实际串行执行

采用存储过程封装事务

存储过程的优缺点

分区

串行执行小结

#### 2. 两阶段加锁

实现两阶段加锁

两阶段加锁的性能

谓词锁

索引区间锁

#### 3. 可串行化的快照隔离

悲观与乐观的并发控制

基于过期的条件做决定

检测是否读取了过期的MVCC对象

检测写是否影响了之前的读

可串行化快照隔离的功能

### 四、小结250

## 第8章 分布式系统的挑战259

### 一、故障与部分失效260

#### 1. 云计算和超算

### 二、不可靠的网络262

#### 1. 现实中的网络故障

#### 2. 检测故障

#### 3. 超时与无限期的延迟

网络拥塞与排队

#### 4. 同步与异步网络

 网络延迟是否可预测？

### 三、不可靠的时钟271

#### 1. 单调时钟与墙上时钟

墙上时钟

单调时钟

#### 2. 时钟同步与准确性

#### 3. 依赖同步的时钟

时间戳与事件顺序

 时钟的置信区间

全局快照的同步时钟

#### 4. 进程暂停

响应时间保证

调整垃圾回收的影响

### 四、知识，真相与谎言282

#### 1. 真相由多数决定 283

主节点与锁

Fencing令牌

#### 2. 拜占庭故障 286

弱的谎言形式

#### 3. 理论系统模型与现实

算法的正确性

安全与活性

将系统模型映射到现实世界

### 五、小结292

## 第9章 一致性与共识303

### 一、一致性保证304

### 二、可线性化305

#### 1. 如何达到线性化？

#### 2. 线性化的依赖条件

加锁与主节点选举

约束与唯一性保证

跨通道的时间依赖

#### 3. 实现线性化系统 313

线性化与quorum

#### 4. 线性化的代价

CAP理论

可线性化与网络延迟

### 三、顺序保证319

#### 1. 顺序与因果关系

因果顺序并非全序

可线性化强于因果一致性

捕获因果依赖关系

#### 2. 序列号排序 323

非因果序列发生器

Lamport时间戳

时间戳排序依然不够

#### 3. 全序关系广播

使用全序关系广播

采用全序关系广播实现线性化存储

采用线性化存储实现全序关系广播

### 四、分布式事务与共识330

#### 1. 原子提交与两阶段提交

从单节点到分布式的原子提交

两阶段提交

系统的承诺

协调者发生故障

三阶段提交

#### 2. 实践中的分布式事务

Exactly-once消息处理

XA交易

停顿时仍持有锁

从协调者故障中恢复

分布式事务的限制

#### 3. 支持容错的共识

共识算法与全序广播

主从复制与共识

Epoch和Quorum

共识的局限性

#### 4. 成员与协调服务

节点任务分配

服务发现

成员服务

### 五、小结349

## 第三部分 派生数据

## 第10章 批处理系统367

### 一、使用UNIX工具进行批处理 368

#### 1. 简单日志分析

命令链与自定义程序

排序与内存中聚合

#### 2. UNIX设计哲学

统一接口

逻辑与布线分离

透明与测试

### 二、MapReduce与分布式文件系统 375

#### 1. MapReduce作业执行

MapReduce的分布式执行

MapReduce工作流

#### 2. Reduce端的join与分组

示例：分析用户活动事件

排序-合并join

将相关数据放在一起

分组

处理数据倾斜

#### 3. map端join操作

广播哈希join

分区哈希join

map端合并join

具有map端join的MapReduce工作流

#### 4. 批处理工作流的输出

生成搜索索引

批处理输出键值

批处理输出的哲学

#### 5. 对比Hadoop与分布式数据库

存储多样性

处理模型的多样性

针对频繁故障的设计

### 三、超越MapReduce 394

#### 1. 中间状态实体化

数据流引擎

容错

关于实体化的讨论

#### 2. 图与迭代处理

Pregel处理模型

容错

并行执行

#### 3. 高级API和语言 400

转向声明式查询语言

不同领域的专业化

### 四、小结 403

## 第11章 流处理系统 413

### 一、发送事件流 414

#### 1. 消息系统

生产者与消费者之间的直接消息传递 416

消息代理

消息代理与数据库对比

多个消费者

确认和重新传递 418

#### 2. 分区日志

基于日志的消息存储 420

对比日志与传统消息系统

消费者偏移量

磁盘空间使用

当消费者跟不上生产者时

重新处理信息 423

### 二、数据库与流 424

#### 1. 保持系统同步

#### 2. 变更数据捕获

实现变更数据捕获

初始快照

日志压缩 428

对变更流的API支持

#### 3. 事件溯源 429

从事件日志导出当前状态 430

命令和事件

#### 4. 状态，流与不可变性 431

不变事件的优势

相同的事件日志派生多个视图

并发控制

不变性的限制

### 三、流处理 435

#### 1. 流处理的适用场景 436

复杂事件处理

流分析

维护物化视图

在流上搜索

消息传递和RPC

#### 2. 流的时间问题 439

事件时间与处理时间

了解什么时候准备就绪

你用谁的时钟？

窗口类型

#### 3. 流式join 443

流和流join（窗口join）

流和表join

表和表join（物化视图维护）

join的时间依赖性

#### 4. 流处理的容错 446

微批处理和校验点

重新审视原子提交

幂等性

故障后重建状态

### 四、小结 449

## 第12章 数据系统的未来 461

### 一、数据集成 461

#### 1. 采用派生数据来组合工具

为何需要数据流

派生数据与分布式事务

全序的局限

排序事件以捕获因果关系

#### 2. 批处理和流处理集成

保持派生状态

为应用程序演化而重新处理数据

Lambda架构

统一批处理和流处理

### 二、分拆数据库 469

#### 1. 编排多种数据存储技术 470

创建一个索引

元数据库

分离式如何工作

分离式与集成式系统

遗漏了什么？

#### 2. 围绕数据流设计应用系统 474

应用程序代码作为派生数据

应用程序代码与状态分离

数据流：状态变化和应用程序代码之间的相互影响

流式处理与服务

#### 3. 观察派生状态 479

实体化视图和缓存

有状态，可离线客户端

状态更改推送至客户端

端到端的事件流

读也是事件

多分区数据处理

### 三、端到端的正确性 484

#### 1. 数据库的端到端争论 485

Exactly-once执行操作 

重复消除

操作标识符

端到端的争论

在数据系统中采用端到端的思路

#### 2. 强制约束 489

唯一性约束需要达成共识

基于日志的消息传递唯一性

多分区请求处理

#### 3. 时效性与完整性 492

数据流系统的正确性

宽松的约束

无需协调的数据系统

#### 4. 信任，但要确认 496

软件缺陷时的完整性

不要盲目信任承诺

验证的文化

可审计性的设计

端到端论点的再讨论

审计数据系统的工具

### 四、做正确的事 500

#### 1. 预测性分析

偏见与歧视

责任与问责

反馈环路

#### 2. 数据隐私与追踪 503

监控

赞成与选择的自由

数据隐私和使用

数据作为资产和权力

记住工业革命

立法与自律

### 五、小结 509